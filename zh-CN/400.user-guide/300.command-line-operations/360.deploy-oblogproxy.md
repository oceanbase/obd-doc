# 通过命令行部署 OBLogProxy

本文以 **全组件部署** 和 **最小化部署** 两种场景为例，介绍如何使用命令行部署 OBLogProxy。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>本文默认所使用的机器可以连接公网，或者已配置好所需软件（OceanBase、ODP、OBLogProxy、Config Server 等）。配置所需软件的详细操作可参考 <a href="../../200.quick-start/100.install-obd.md"> 安装并配置 OBD</a> 中 <b>配置 OBD</b>。</p>
</main>

## 组件介绍

* OBProxy

  OceanBase Database Proxy，OceanBase 数据库代理，是 OceanBase 数据库专用的代理服务器，简称为 ODP（又称为 OBProxy）。详细信息请参见 [ODP 文档](https://www.oceanbase.com/docs/odp-cn)。

* Config Server
  
  OceanBase Configserver，Config Server 可提供 OceanBase 的元数据注册，存储和查询服务。详细信息请参见 [ob-configserver](https://github.com/oceanbase/oceanbase/tree/master/tools/ob-configserver)。

* OBLogProxy
  
  OceanBase 的增量日志代理服务，它可以与 OceanBase 建立连接并进行增量日志读取，为下游服务提供了变更数据捕获（CDC）的能力。详细信息请参见 [OceanBase 日志代理服务文档](https://www.oceanbase.com/docs/oblogproxy-doc)。

## 配置文件

OBD 提供了部署 OBLogProxy 所需的配置文件示例，您可根据自身机器资源情况进行修改。

* 若您机器中的 OBD 是通过直接下载的方式安装，则可在 `/usr/obd/example/oblogproxy` 目录下查看 OBD 提供的 OBLogProxy 配置文件示例。

* 若您机器中的 OBD 是通过解压 all-in-one 安装包的方式安装，则可在 `~/.oceanbase-all-in-one/conf/oblogproxy` 目录下查看 OBD 提供的 OBLogProxy 配置文件示例。

* 您也可在 OBD 的 [GitHub 仓库](https://github.com/oceanbase/obdeploy/tree/master/example/oblogproxy) 中查看 OBD 提供的 OBLogProxy 配置文件示例。

OBD 提供的和部署 OBLogProxy 相关的配置文件示例有如下几个。

* 全组件部署（oceanbase-ce、obproxy-ce、ob-configserver、oblogproxy）：distributed-with-obproxy-and-oblogproxy-example.yaml

* 最小化部署（仅部署 OBLogProxy）：oblogproxy-only-example.yaml

## 全组件部署

### 使用场景

当前环境中未部署任何 OceanBase 组件，所有组件（oceanbase-ce、obproxy-ce、ob-configserver、oblogproxy）均由 OBD 在一个集群中进行部署。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>若无需使用 OBLogProxy 的 Binlog Service 服务，可不部署 OBProxy 和 Config Server。</p>
</main>

### 前提条件

部署 OBLogProxy 前，您需确认已安装 V2.5.0 或之后版本的 OBD。若您环境中 OBD 为 V2.5.0 之前版本，可参考 [常见问题](../../500.faq/100.faq.md) 中 **如何升级 OBD** 一节升级 OBD。

### 操作步骤

此处以 `distributed-with-obproxy-and-oblogproxy-example.yaml` 配置文件为例，介绍如何部署 OBLogProxy。

1. 配置用户信息

   配置文件中，用户信息相关的配置如下：

   ```yaml
   ## Only need to configure when remote login is required
   user:
     username: admin
   #   password: your password if need
     key_file: /home/admin/.ssh/id_rsa
   #   port: your ssh port, default 22
   #   timeout: ssh connection timeout (second), default 30
   ```

   `username` 为登录到目标机器的用户名，确保您的用户名有 `home_path` 的写权限。`password` 和 `key_file` 均用于验证用户，通常情况下只需要填写一个。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>在配置秘钥路径后，如果您的秘钥不需要口令，请注释或者删除 <code>password</code>，以免 <code>password</code> 被视为秘钥口令用于登录，导致校验失败。</p>
   </main>

2. 配置 oceanbase-ce 组件

   部署 OBLogProxy 时需要为 OBLogProxy 创建一个拥有只读权限的用户（`cdcro@sys`）。`cdcro@sys` 用户归属于 OceanBase 数据库，OBLogProxy 仅拥有该用户的使用权。

   配置文件中，oceanbase-ce 组件的配置信息如下：

   ```yaml
   oceanbase-ce:
     servers:
       - name: server1
         # Please don't use hostname, only IP can be supported
         ip: 10.10.10.1
       - name: server2
         ip: 10.10.10.2
       - name: server3
         ip: 10.10.10.3
     depends:
       - ob-configserver
     global:
       memory_limit: 64G # The maximum running memory for an observer
       # The reserved system memory. system_memory is reserved for general tenants. The default value is 30G.
       system_memory: 30G
       datafile_size: 192G # Size of the data file. 
       log_disk_size: 192G # The size of disk space used by the clog files.
       enable_syslog_wf: false # Print system logs whose levels are higher than WARNING to a separate log file. The default value is true.
       enable_syslog_recycle: true # Enable auto system log recycling or not. The default value is false.
       max_syslog_file_count: 4 # The maximum number of reserved log files before enabling auto recycling. The default value is 0.
       # observer cluster name, consistent with obproxy's cluster_name
       appname: obcluster
       root_password: ******** # root user password, can be empty
       proxyro_password: ******** # proxyro user password, consistent with obproxy's observer_sys_password, can be empty
       cdcro_password: ******** # cdcro user password, consistent with oblogproxy's observer_sys_password, can be empty
     server1:
       mysql_port: 2881 # External port for OceanBase Database. The default value is 2881. DO NOT change this value after the cluster is started.
       rpc_port: 2882 # Internal port for OceanBase Database. The default value is 2882. DO NOT change this value after the cluster is started.
       #  The working directory for OceanBase Database. OceanBase Database is started under this directory. This is a required field.
       home_path: /home/admin/observer
       # The directory for data storage. The default value is $home_path/store.
       # data_dir: /data
       # The directory for clog, ilog, and slog. The default value is the same as the data_dir value.
       # redo_dir: /redo
       zone: zone1
     server2:
       mysql_port: 2881 # External port for OceanBase Database. The default value is 2881. DO NOT change this value after the cluster is started.
       rpc_port: 2882 # Internal port for OceanBase Database. The default value is 2882. DO NOT change this value after the cluster is started.
       #  The working directory for OceanBase Database. OceanBase Database is started under this directory. This is a required field.
       home_path: /home/admin/observer
       # The directory for data storage. The default value is $home_path/store.
       # data_dir: /data
       # The directory for clog, ilog, and slog. The default value is the same as the data_dir value.
       # redo_dir: /redo
       zone: zone2
     server3:
       mysql_port: 2881 # External port for OceanBase Database. The default value is 2881. DO NOT change this value after the cluster is started.
       rpc_port: 2882 # Internal port for OceanBase Database. The default value is 2882. DO NOT change this value after the cluster is started.
       #  The working directory for OceanBase Database. OceanBase Database is started under this directory. This is a required field.
       home_path: /home/admin/observer
       # The directory for data storage. The default value is $home_path/store.
       # data_dir: /data
       # The directory for clog, ilog, and slog. The default value is the same as the data_dir value.
       # redo_dir: /redo
       zone: zone3
   ```

   详细的配置项介绍可参见 [配置文件说明](../100.configuration-file-description.md) 中 **配置项说明** 章节下 **OceanBase 数据库** 部分介绍。与单独部署 OceanBase 集群相比，配置文件中新增了配置项 `cdcro_password`，该配置项用于配置 `cdcro@sys` 用户密码，未配置的情况下，OBD 会自动生成随机字符串。

3. 配置 obproxy-ce 和 ob-configserver 组件

   配置文件中，obproxy-ce 和 ob-configserver 组件的配置信息如下：

   ```yaml
   obproxy-ce:
     depends:
       - oceanbase-ce
     servers:
       - 10.10.10.1
     global:
       listen_port: 2883 # External port. The default value is 2883.
       prometheus_listen_port: 2884 # The Prometheus port. The default value is 2884.
       home_path: /home/admin/obproxy
       enable_cluster_checkout: false
       # observer cluster name, consistent with oceanbase-ce's appname. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
       # cluster_name: obcluster
       skip_proxy_sys_private_check: true
       enable_strict_kernel_release: false
       obproxy_sys_password: ******** # obproxy sys user password, can be empty. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
       # observer_sys_password: # proxyro user pasword, consistent with oceanbase-ce's proxyro_password, can be empty. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
   ob-configserver:
     servers:
       - 10.10.10.1
     global:
       listen_port: 8080 # The port of ob-configserver web
       # server_ip: 0.0.0.0 # Listen to the ob-configserver server IP。When you want to listen to the specified IP address,use it.
       home_path: /home/admin/ob-configserver  # The working directory for prometheus. ob-configserver is started under this directory. This is a required field.
       ## log config
       # log_level: info # Log printing level of ob-configserver。The default value is `info`
       # log_maxsize: 30 # The total size of manager ob-configserver.Log size is measured in Megabytes.The default value is 30
       # log_maxage: 7 # The days of manager expired ob-configserver.Log retention days. The default value is 7
       # log_maxbackups: 10  #The number of manager expired ob-configserver.Log. The default value is 10
       # log_localtime: true #  Switch of ob-configserver.Log naming with localtime. The default value is true
       # log_compress: true # Compress ob-configserver.Log switch. The default value is true
   
       ## vip config, configserver will generate url with vip_address and port and return it to the client
       ## do not use some random value that can't be connected
       # vip_address: "10.10.10.1"
       # vip_port: 8080
       ## storage config
       # storage:
       #   database_type: sqlite3 # sqlite3 or mysql. Default sqlite3
       #   connection_url: "" # When database_type is set to sqlite3, the connection_url parameter can be left empty. If it is empty, the default value $home_path/.data.db?cache=shared&_fk=1 will be used. When database_type is set to mysql, the connection_url parameter must be configured, with a sample value of user:password@tcp(10.10.10.1:2883)/test?parseTime=true.
   ```

   详细的配置项介绍可参见 [配置文件说明](../100.configuration-file-description.md) 中 **配置项说明** 章节下 **ODP** 和 **Config Server** 部分介绍。

4. 配置 oblogproxy 组件

   配置文件中，oblogproxy 组件的配置信息如下：

   ```yaml
   oblogproxy:
     version: 2.0.0
     depends:
       - oceanbase-ce
       - obproxy-ce
     servers:
       - 10.10.10.1
     global:
       home_path: /home/admin/oblogproxy
       service_port: 2983
       # binlog_dir: /home/admin/oblogproxy/run   # The directory for binlog file. The default value is $home_path/run.
       # binlog_mode: true   # enable binlog mode, default true
       # ob_sys_password:  # cdcro user pasword, consistent with oceanbase-ce's cdcro_password, can be empty. When a depends exists, OBD gets this value from the oceanbase-ce of the depends.
   ```

   配置文件中配置 oblogproxy 依赖于 oceanbase-ce 和 obproxy-ce 组件，配置文件介绍如下：

   |  配置项       |  是否必选  |  默认值  |  说明     |
   |--------------|-----------|----------|----------|
   | version      | 可选      | 默认部署最新版本 | 指定待部署组件版本，通常情况下不需要指定。 |
   | servers      | 必选      | 无              | 每台机器需要用 `- name: 机器标识名 (换行)ip: 机器 IP` 指定，也可以使用 `- <ip>` 的格式指定，此时 `- <ip>` 的格式相当于 `- name: 机器 IP（换行）ip: 机器 IP`。 |
   | home_path    | 必选    | 无                | OBLogProxy 的安装路径。 |
   | service_port | 必选    | 2983              | OBLogProxy 服务监听端口。 |
   | binlog_dir   | 可选    | $home_path/run    | Binlog 服务目录根路径，需配置为绝对路径。 |
   | binlog_mode  | 可选    | true              | 控制是否开启 Binlog 模式。 |
   | ob_sys_password | 可选 | <ul><li>配置依赖于 oceanbase-ce 组件时，默认与 <code>cdcro_password</code> 相同。</li><li>未配置依赖于 oceanbase-ce 组件时，默认为空。</li></ul> | 用于配置 `cdcro@sys` 用户密码，需与 oceanbase-ce 组件下的 `cdcro_password` 保持一致。 |

   其他 OBLogProxy 相关配置项可参见《OceanBase 日志代理服务》文档中 [配置文件](https://www.oceanbase.com/docs/community-oblogproxy-doc-1000000000438536) 一文，需要注意如下几点：

   * 使用 OBD 部署 OBLogProxy 时，OBD 中的 `binlog_dir` 配置项对应 OBLogProxy 原本的 `binlog_log_bin_basename` 配置项。

   * 使用 OBD 部署 OBLogProxy 时，`binlog_mode` 配置项的默认值为 `true`。

5. 部署集群

   ```shell
   [admin@test001 ~]$ obd cluster deploy obtest -c distributed-with-obproxy-and-oblogproxy-example.yaml
   ```

   联网情况下，在您执行了 `obd cluster deploy` 命令之后，OBD 将检查您的目标机器是否有部署所需安装包。如果没有安装包，OBD 将自动从 YUM 源获取。

6. 启动集群

   ```shell
   [admin@test001 ~]$ obd cluster start obtest
   ```

7. 查看集群状态

   ```shell
   [admin@test001 ~]$ obd cluster display obtest
   ```

## 最小化部署

### 使用场景

环境中已存在 OceanBase 集群，需要使用 OBLogProxy 的服务，此时仅需要部署 OBLogProxy。

### 前提条件

部署 OBLogProxy 前，您需确认已安装 V2.5.0 或之后版本的 OBD。若您环境中 OBD 为 V2.5.0 之前版本，可参考 [常见问题](../../500.faq/100.faq.md) 中 **如何升级 OBD** 一节升级 OBD。

### 操作步骤

此处以 `oblogproxy-only-example.yaml` 配置文件为例，介绍如何部署 OBLogProxy。

1. 配置用户信息

   配置文件中，用户信息相关的配置如下：

   ```yaml
   ## Only need to configure when remote login is required
   user:
     username: admin
   #   password: your password if need
     key_file: /home/admin/.ssh/id_rsa
   #   port: your ssh port, default 22
   #   timeout: ssh connection timeout (second), default 30
   ```

   `username` 为登录到目标机器的用户名，确保您的用户名有 `home_path` 的写权限。`password` 和 `key_file` 均用于验证用户，通常情况下只需要填写一个。

   <main id="notice" type='notice'>
     <h4>注意</h4>
     <p>在配置秘钥路径后，如果您的秘钥不需要口令，请注释或者删除 <code>password</code>，以免 <code>password</code> 被视为秘钥口令用于登录，导致校验失败。</p>
   </main>

2. 配置 oblogproxy 组件

   配置文件中，oblogproxy 组件的配置信息如下：

   ```yaml
   oblogproxy:
     version: 2.0.0
     servers:
       - 10.10.10.1
     global:
       home_path: /home/admin/oblogproxy
       service_port: 2983
       ob_sys_username: cdcro  # A user under the sys tenant of oceanbase-ce, oblogproxy communicates with oceanbase-ce using this user, default ''
       ob_sys_password: ******** # ob_sys_username`s password, default ''
       # binlog_dir: /home/admin/oblogproxy/run   # The directory for binlog file. The default value is $home_path/run.
       # binlog_mode: true   # enable binlog mode, default true
   ```

   配置项介绍如下：

   |  配置项       |  是否必选  |  默认值  |  说明     |
   |--------------|-----------|----------|----------|
   | version      | 可选      | 默认部署最新版本 | 指定待部署组件版本，通常情况下不需要指定。 |
   | servers      | 必选      | 无              | 每台机器需要用 `- name: 机器标识名 (换行)ip: 机器 IP` 指定，也可以使用 `- <ip>` 的格式指定，此时 `- <ip>` 的格式相当于 `- name: 机器 IP（换行）ip: 机器 IP`。 |
   | home_path    | 必选    | 无                | OBLogProxy 的安装路径。 |
   | service_port | 必选    | 2983              | OBLogProxy 服务监听端口。 |
   | ob_sys_username | 可选 | 默认为空            | OBLogProxy 与 OceanBase 数据库通信的用户名，需要是 sys 租户下的用户，需提前创建。此处的用户名仅需配置 user_name，不需要包含集群名称或租户名称。   |
   | ob_sys_password | 可选 | 默认为空 | `ob_sys_username` 配置项对应用户的密码，需与 OceanBase 数据库中对应用户的密码保持一致。 |
   | binlog_dir   | 可选    | $home_path/run    | Binlog 服务目录根路径，需配置为绝对路径。 |
   | binlog_mode  | 可选    | true              | 控制是否开启 Binlog 模式。 |

   其他 OBLogProxy 相关配置项可参见《OceanBase 日志代理服务》文档中 [配置文件](https://www.oceanbase.com/docs/community-oblogproxy-doc-1000000000438536) 一文，需要注意如下几点：

   * 使用 OBD 部署 OBLogProxy 时，OBD 中的 `binlog_dir` 配置项对应 OBLogProxy 原本的 `binlog_log_bin_basename` 配置项。

   * 使用 OBD 部署 OBLogProxy 时，`binlog_mode` 配置项的默认值为 `true`。

   * 使用 OBD 部署 OBLogProxy 时，`ob_sys_username` 和 `ob_sys_password` 配置项需配置为明文。

3. 部署 OBLogProxy

   ```shell
   [admin@test001 ~]$ obd cluster deploy obtest -c oblogproxy-only-example.yaml
   ```

   联网情况下，在您执行了 `obd cluster deploy` 命令之后，OBD 将检查您的目标机器是否有部署所需安装包。如果没有安装包，OBD 将自动从 YUM 源获取。

4. 启动 OBLogProxy

   ```shell
   [admin@test001 ~]$ obd cluster start obtest
   ```

5. 查看 OBLogProxy 状态

   ```shell
   [admin@test001 ~]$ obd cluster display obtest
   ```

## 验证

您可通过如下步骤验证部署的 OBLogProxy 是否可用。

1. 连接验证

   复制启动成功后 OBD 打印的连接串并执行，验证是否可以成功连接 OBLogProxy。

   ```shell
   obclient -h10.10.10.1 -P2983
   ```

2. 进程验证

   在 OBLogProxy 所在机器执行如下命令，查看是否有 oblogproxy 进程。

   ```shell
   ps axu | grep logproxy
   ```

   输出如下：

   ```shell
   admin    10493  1.1  0.0 634812  2940 ?        Sl   16:21   0:07 /home/admin/oblogproxy/bin/logproxy -f /home/admin/oblogproxy/conf/conf.json
   admin    18071  0.0  0.0 112812   980 pts/1    S+   16:32   0:00 grep --color=auto logproxy
   ```

## （可选）使用 Binlog Service 服务

本节介绍使用 OBD 部署 OBLogProxy 后如何使用 Binlog Service 服务。Binlog Service 服务的详细介绍可参见《OceanBase 日志代理服务》文档中 [Binlog 模式](https://www.oceanbase.com/docs/community-oblogproxy-doc-1000000000438546)。

### 前提条件

* 当前环境中拥有一个运行中的 OceanBase 集群。

* 当前运行中的 OceanBase 集群中 sys 租户下已存在一个拥有只读权限的用户。

* 您已部署 OBProxy 和 Config Server。

### 步骤一：配置 OBProxy

Binlog 下游服务（即 MySQL Binlog 生态工具）实际交互时是与 OBProxy 进行交互的，并不感知 OBLogProxy，所有请求均由 OBProxy 转发给 OceanBase 数据库或 OBLogProxy（SQL 转发给 OceanBase 数据库，Binlog 订阅及相关命令转发给 OBLogProxy），因此需要在 OBProxy 上配置 OBLogProxy 的服务地址（即提供 Binlog Service 的服务地址）。

具体操作步骤如下。

1. 使用 root 用户登录 OceanBase 数据库的 sys 租户

   ```shell
   obclient -h10.10.10.1 -P2883 -uroot@sys -p -Doceanbase -A
   ```

   在 OceanBase 数据库中配置 OBProxy 时，必须通过 OBProxy 代理方式登录 OceanBase 数据库，即使用的 IP 需为 OBProxy 的 IP 地址，使用的端口需为 OBProxy 的访问端口（obproxy-ce 组件下的 `listen_port` 配置项）。

2. 配置 Binlog Service 服务地址

   ```shell
   alter proxyconfig set binlog_service_ip='ip:port';
   ```

3. 设置允许 OBProxy 向 OBLogProxy 发送 Binlog 请求

   ```shell
   alter proxyconfig set enable_binlog_service='True';
   ```

   `enable_binlog_service` 配置项自 OBProxy V4.1.0 版本开始引入，并于 V4.2.2 版本弃用，如果配置时提示该配置项不存在，则只需关注 `binlog_service_ip` 配置项即可。

4. 设置 `init_sql`，开启 `show_ddl_in_compat_mode`

   ```shell
   alter proxyconfig set init_sql='set _show_ddl_in_compat_mode = 1;';
   ```

   有关于 `init_sql` 和 `_show_ddl_in_compat_mode` 的介绍可参考《OceanBase 日志代理服务》文档中 [Binlog 模式兼容性](https://www.oceanbase.com/docs/community-oblogproxy-doc-1000000000438547) 一文。

### 步骤二：创建 Binlog 服务

本文以一个示例简单介绍如何创建 Binlog 服务，详细的命令介绍可参见《OceanBase 日志代理服务》文档中 [使用 Binlog 模式](https://www.oceanbase.com/docs/community-oblogproxy-doc-1000000000438549) 一文。

1. 直连 OBLogProxy

   ```shell
   obclient -h10.10.10.1 -P2983
   ```

2. 创建 Binlog 服务

   ```shell
   CREATE BINLOG FOR TENANT `obcluster`.`test` TO USER `cdcro` PASSWORD `<password>` WITH CLUSTER URL `cluster_url`;
   ```

   其中：

   * `obcluster`.`test`：需要使用 Binlog 服务的 OceanBase 集群的集群名和租户名，您需根据实际情况进行替换。

   * `cdcro`：OBLogProxy 与 OceanBase 数据库通信的用户名，需要是 sys 租户下的用户。全组件部署时该用户必须为 cdcro，最小化部署时可以为 sys 租户下的任意用户，需提前创建。

   * `<password>`：OBLogProxy 与 OceanBase 数据库通信的用户的密码。若全组件部署 OBLogProxy 时未配置，可执行 `obd cluster edit-config` 命令打开配置文件查看（cdcro_password 配置项）。

   * `cluster_url`：OceanBase 数据库中的 `config_url`，可登录 OceanBase 数据库后执行 `show parameters like '%config_url%';` 命令查看。

### 步骤三：验证

在 OBLogProxy 所在机器执行如下命令，查看是否有 binlog_converter 进程。

```shell
ps axu | grep logproxy
```

输出如下：

```shell
admin    10493  1.1  0.0 1355708 3156 ?        Sl   16:21   0:19 /home/admin/oblogproxy/bin/logproxy -f /home/admin/oblogproxy/conf/conf.json
admin    29088  9.2  2.3 11354828 729996 ?     Sl   16:50   0:01 ./binlog_converter binlog_converter.conf /home/admin/oblogproxy/run/obcluster/test
admin    29465  0.0  0.0 112816   980 pts/1    S+   16:50   0:00 grep --color=auto logproxy
```

## 相关文档

您可使用 OBD 对管理部署的 OBLogProxy，如启动、停止、重启、销毁等，详细的命令使用可参见 [集群命令组](../../300.obd-command/100.cluster-command-groups.md)。需要注意的是，执行 `obd cluster stop` 命令停止 OBLogProxy 时，OBD 只会停止 oblogproxy 进程，不会停止 Binlog 进程（binlog_converter）。
