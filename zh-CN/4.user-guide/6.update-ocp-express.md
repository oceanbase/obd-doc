# 升级 OCP Express

本文介绍如何通过 OBD 黑屏命令行升级 OCP Express。

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>目前仅支持通过 OBD 黑屏命令行方式升级 OCP Express。</p>
</main>

## 前提条件
<!-- 需确认对于 OBD 的版本有无要求，有 hash 的话，2.0 的OBD 是否也可以升级 OCP Express -->
请确保您已部署 OCP Express。

## 获取 OCP Express hash 值

升级 OCP Express 前您需知道升级的目标版本的 hash 值，可根据自身机器情况选择如下两种方式中任意一种获取 hash 值。

### 方法一：在线获取

如果您的机器可以连接公网，可以通过升级 OBD 后利用 OBD 获取远程资源。参考如下步骤。

1. 执行如下命令开启远程镜像仓库

   ```shell
   obd mirror enable remote
   ```

2. 执行如下命令升级 OBD 到最新版本

   ```shell
   obd update
   ```

3. 执行如下命令查看 OBD 版本，验证是否升级成功

   ```shell
   obd --version
   ```

4. 执行如下命令查询远程仓库中 OCP Express 版本

   ```shell
   obd mirror list oceanbase.community.stable|grep ocp-express
   ```

   ```shell
   | ocp-express                       | 1.0.0   | 100000432023032015.el7 | x86_64 | c6156b6676746d697e0bb46b50a062ce188cb76f2f95f1fd4d6ac14dd8d71f76 |
   | ocp-express                       | 1.0.0   | 100000452023041914.el7 | x86_64 | a70d09919bcbad065270e8ff3984ef18c332c2f5983b756fc55956ce910f7d2d |
   ```

   最后一列字符串即为 OCP Express 对应版本的 hash 值。

### 方法二：离线获取

当您的机器无法连接网络时，您可通过下载 all-in-one 安装包升级 OBD 并获取资源，具体步骤如下。

1. 下载 all-in-one 安装包

   从 [OceanBase 软件下载中心](https://www.oceanbase.com/softwarecenter) 下载 all-in-one 安装包，并将其复制到中控机中，推荐下载最新版本的安装包。

2. 在安装包所在目录下执行如下命令解压安装包并安装

   <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>如果之前已经安装过 all-in-one 安装包，本次升级需使用与之前相同的主机账号（比如 admin）登录，然后执行如下命令解压覆盖即可实现升级。即如果之前是通过 admin 用户安装的 all-in-one 安装包，本次升级仍需使用 admin 用户进行安装。</p>
   </main>

   ```shell
   [admin@test001 ~]$ tar -xzf oceanbase-all-in-one-*.tar.gz
   [admin@test001 ~]$ cd oceanbase-all-in-one/bin/
   [admin@test001 bin]$ ./install.sh
   [admin@test001 bin]$ source ~/.oceanbase-all-in-one/bin/env.sh
   ```

3. 执行如下命令查询远程仓库中 OCP Express 版本

   ```shell
   obd mirror list local
   ```

   ```shell
   +----------------------------------------------------------------------------------------------------------+
   |                                            local Package List                                            |
   +-------------------+---------+------------------------+--------+------------------------------------------+
   | name              | version | release                | arch   | md5                                      |
   +-------------------+---------+------------------------+--------+------------------------------------------+
   | grafana           | 7.5.17  | 1                      | x86_64 | 1bf1f338d3a3445d8599dc6902e7aeed4de4e0d6 |
   | obagent           | 1.3.0   | 22.el7                 | x86_64 | d57fbb4962b2fbecb6282358c59295fdfba4d6ac |
   | obproxy-ce        | 4.1.0.0 | 7.el7                  | x86_64 | 2a9d9bf67f179dcca2a8c9e7c77373d94e7e2abe |
   | oceanbase-ce      | 4.1.0.0 | 100000192023032010.el7 | x86_64 | 8439ecf8db5e0649bd49671b41ea9e8c85756b63 |
   | oceanbase-ce      | 4.1.0.0 | 100000202023040520.el7 | x86_64 | d598937b1cfb1df85e2c2231acf024e4994db533 |
   | oceanbase-ce-libs | 4.1.0.0 | 100000192023032010.el7 | x86_64 | a83b1dd1cab44d3f610d439931322be7a08555f2 |
   | oceanbase-ce-libs | 4.1.0.0 | 100000202023040520.el7 | x86_64 | 5d24535db655b4dce6fc62aedc4d0e867225792a |
   | ocp-express       | 1.0.0   | 100000432023032015.el7 | x86_64 | 42c6fc921063f24f9e1072d75bfa7f21f42146e3 |
   | ocp-express       | 1.0.0   | 100000452023041914.el7 | x86_64 | 5b29837dc1f575c7d1840ab8e59064ddd407bd4b |
   | prometheus        | 2.37.1  | 10000102022110211.el7  | x86_64 | 58913c7606f05feb01bc1c6410346e5fc31cf263 |
   +-------------------+---------+------------------------+--------+------------------------------------------+
   Trace ID: c11bf0e8-e277-11ed-b6cc-00163e04ccdf
   If you want to view detailed obd logs, please run: obd display-trace c11bf0e8-e277-11ed-b6cc-00163e04ccdf
   ```

## 升级 OCP Express

OCP Express 升级需通过 `obd cluster reinstall` 命令，详情请参见 [集群命令组](../3.obd-command/1.cluster-command-groups.md) 中 `obd cluster reinstall` 命令介绍。

通过上面的任意一种方式获取到 ocp-express 组件的 hash 值（md5）后执行如下命令进行升级安装。

```shell
obd cluster reinstall obtest -c ocp-express --hash a70d09919bcbad065270e8ff3984ef18c332c2f5983b756fc55956ce910f7d2d
```

### 验证

OCP Express 升级后的登录账号密码与升级前相同。登录后查看 **帮助** -> **关于 ocp express**，查看版本号与发布日期即可验证是否已升级到目标版本。
